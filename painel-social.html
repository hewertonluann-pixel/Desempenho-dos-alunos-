<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel Social üéµ ‚Äî Orquestra</title>

  <!-- Reutiliza base visual do aluno (fonte, cores, etc) -->
  <link rel="stylesheet" href="aluno.css" />

  <style>
    body {
      background: #0b1020;
      color: #e5e7eb;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #22d3ee;
      margin-bottom: 4px;
      font-size: 1.6rem;
    }

    .subtitulo {
      text-align: center;
      color: #9ca3af;
      margin-bottom: 24px;
      font-size: 0.95rem;
    }

    .grid-social {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .card-social {
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 16px;
      padding: 14px 14px 12px;
      border: 1px solid rgba(34, 211, 238, 0.22);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.7);
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }

    .card-social:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 35px rgba(8, 47, 73, 0.85);
      border-color: rgba(56, 189, 248, 0.7);
    }

    .topo-card {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .foto-social {
      width: 64px;
      height: 64px;
      border-radius: 999px;
      overflow: hidden;
      border: 2px solid rgba(34, 211, 238, 0.5);
      flex-shrink: 0;
      background: #020617;
    }

    .foto-social img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .info-principal {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .nome-aluno {
      font-size: 1rem;
      font-weight: 600;
      color: #f9fafb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .instrumento-aluno {
      font-size: 0.85rem;
      color: #9ca3af;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* N√≠vel Geral em Destaque */
    .nivel-geral-destaque {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.15), rgba(56, 189, 248, 0.08));
      border-radius: 10px;
      border: 1px solid rgba(34, 211, 238, 0.3);
      margin-top: 8px;
    }

    .label-nivel {
      font-size: 0.85rem;
      font-weight: 600;
      color: #22d3ee;
    }

    .valor-nivel {
      font-size: 1.4rem;
      font-weight: 700;
      color: #f9fafb;
    }

    /* N√≠veis Secund√°rios (Leitura e M√©todo) */
    .niveis-secundarios {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }

    .nivel-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 8px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .nivel-item .valor {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 0.9rem;
    }

    /* Barras de Comprometimento */
    .barra-comprometimento {
      margin-top: 8px;
    }

    .barra-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #e5e7eb;
      margin-bottom: 4px;
    }

    .barra-container {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
    }

    .barra-preenchimento {
      height: 100%;
      width: 0%;
      transition: width 0.4s ease;
      border-radius: 999px;
    }

    /* Conquistas */
    .conquistas-social {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid rgba(34, 211, 238, 0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .conquistas-social .icones {
      font-size: 1.3rem;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    /* Responsivo: mais respiro em telas grandes */
    @media (min-width: 1024px) {
      body {
        padding-inline: 40px;
      }
    }
  </style>
</head>

<body>

  <h1>üé∂ Comunidade Asafe</h1>
  <p class="subtitulo">Veja seus colegas, suas energias, n√≠veis e conquistas. Toque em um card para abrir o painel completo.</p>

  <div class="grid-social" id="gridSocial"></div>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { regrasDeConquistas } from "./conquistas.js";
    import { obterEventosDoAno, agruparEventosPorMes } from "./frequencia.js";

    const grid = document.getElementById("gridSocial");

    function calcularConquistas(aluno) {
      const desbloqueadas = regrasDeConquistas
        .filter(regra => regra.condicao(aluno))
        .map(regra => regra.icone);

      return desbloqueadas.length > 0 ? desbloqueadas.join(" ") : "‚Äî";
    }

    function corBarraEnergia(energia) {
      if (energia < 40) {
        return "linear-gradient(90deg, #f97373, #fb923c)";
      } else if (energia < 80) {
        return "linear-gradient(90deg, #facc15, #fef08a)";
      } else {
        return "linear-gradient(90deg, #22c55e, #4ade80)";
      }
    }

    // Calcular energia anual (mesmo c√°lculo do aluno3.js)
    async function calcularEnergiaAnual(aluno) {
      const anoAtual = 2026;
      const eventos = await obterEventosDoAno(anoAtual);
      const grupos = agruparEventosPorMes(eventos);
      
      let totalEventosAno = 0;
      let totalPresencasAno = 0;
      
      Object.keys(grupos).forEach(chave => {
        if (chave.startsWith(String(anoAtual))) {
          const eventosDoMes = grupos[chave];
          eventosDoMes.forEach(evento => {
            totalEventosAno++;
            const hit = evento.presencas.find(p => p.nome === aluno.nome);
            if (hit && hit.presenca === "presente") {
              totalPresencasAno++;
            }
          });
        }
      });
      
      return totalEventosAno > 0 
        ? Math.round((totalPresencasAno / totalEventosAno) * 100) 
        : 0;
    }

    async function carregarAlunos() {
      const snap = await getDocs(collection(db, "alunos"));
      const alunos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      // Calcular energia anual para cada aluno
      const alunosComEnergia = await Promise.all(
        alunos.map(async (aluno) => {
          const energiaAnual = await calcularEnergiaAnual(aluno);
          return { ...aluno, energiaAnual };
        })
      );

      // Ordenar: 1) Maestro, 2) L√≠deres (classificados), 3) Por comprometimento (energia anual)
      alunosComEnergia.sort((a, b) => {
        // 1. Maestro sempre primeiro
        const aMaestro = a.instrumento === "Maestro" ? 1 : 0;
        const bMaestro = b.instrumento === "Maestro" ? 1 : 0;
        if (aMaestro !== bMaestro) return bMaestro - aMaestro;
        
        // 2. L√≠deres (classificados) depois do maestro
        const aLider = a.classificado === true ? 1 : 0;
        const bLider = b.classificado === true ? 1 : 0;
        if (aLider !== bLider) return bLider - aLider;
        
        // 3. Demais alunos por energia anual (comprometimento)
        return (b.energiaAnual ?? 0) - (a.energiaAnual ?? 0);
      });

      grid.innerHTML = alunosComEnergia.map(aluno => {
        const energiaMensal = aluno.frequenciaMensal?.porcentagem ?? 0;
        const energiaGeral = aluno.energiaAnual ?? 0; // Usar o valor calculado
        const total = (aluno.leitura ?? 0) + (aluno.metodo ?? 0);
        const conquistas = calcularConquistas(aluno);

        const bgBarraMensal = corBarraEnergia(energiaMensal);
        const bgBarraGeral = corBarraEnergia(energiaGeral);

        return `
          <div class="card-social"
               onclick="window.location.href='aluno.html?nome=${encodeURIComponent(aluno.nome)}&view=public'">

            <div class="topo-card">
              <div class="foto-social">
                ${aluno.foto ? `<img src="${aluno.foto}" alt="${aluno.nome}">` : ""}
              </div>

              <div class="info-principal">
                <div class="nome-aluno">${aluno.nome}</div>
                <div class="instrumento-aluno">${aluno.instrumento ?? ""}</div>
              </div>
            </div>

            <!-- N√≠vel Geral em Destaque -->
            <div class="nivel-geral-destaque">
              <span class="label-nivel">üéØ N√≠vel Geral</span>
              <span class="valor-nivel">${total}</span>
            </div>

            <!-- Leitura e M√©todo -->
            <div class="niveis-secundarios">
              <div class="nivel-item">
                <span>üìò Leitura</span>
                <span class="valor">${aluno.leitura ?? 0}</span>
              </div>
              <div class="nivel-item">
                <span>üéµ M√©todo</span>
                <span class="valor">${aluno.metodo ?? 0}</span>
              </div>
            </div>

            <!-- Barra Geral -->
            <div class="barra-comprometimento">
              <div class="barra-label">
                <span>üìä Geral</span>
                <span>${energiaGeral}%</span>
              </div>
              <div class="barra-container">
                <div class="barra-preenchimento"
                     style="width:${energiaGeral}%; background:linear-gradient(90deg, #3b82f6, #60a5fa);"></div>
              </div>
            </div>

            <!-- Barra Mensal -->
            <div class="barra-comprometimento">
              <div class="barra-label">
                <span>üìÖ Mensal</span>
                <span>${energiaMensal}%</span>
              </div>
              <div class="barra-container">
                <div class="barra-preenchimento"
                     style="width:${energiaMensal}%; background:${bgBarraMensal};"></div>
              </div>
            </div>

            <!-- Conquistas -->
            <div class="conquistas-social">
              <span>üèÜ Conquistas</span>
              <span class="icones">${conquistas}</span>
            </div>

          </div>
        `;
      }).join("");
    }

    carregarAlunos();
  </script>

<script type="module" src="navegacao.js"></script>
  
</body>
</html>
