<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login ‚Äî Orquestra Filhos de Asafe</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(160deg, #0a0f1f 0%, #0b1530 60%, #0a0f1f 100%);
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: #e2e8f0;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      top: -40%; left: -20%;
      width: 70vw; height: 70vw;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(34,211,238,0.06) 0%, transparent 70%);
      pointer-events: none;
      animation: pulse 8s ease-in-out infinite alternate;
    }
    body::after {
      content: "";
      position: fixed;
      bottom: -30%; right: -15%;
      width: 55vw; height: 55vw;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(56,189,248,0.05) 0%, transparent 70%);
      pointer-events: none;
      animation: pulse 10s ease-in-out infinite alternate-reverse;
    }
    @keyframes pulse {
      from { transform: scale(1);    opacity: 0.6; }
      to   { transform: scale(1.15); opacity: 1;   }
    }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    .login-card {
      position: relative;
      z-index: 1;
      background: rgba(17, 24, 39, 0.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      width: 100%;
      max-width: 380px;
      border-radius: 20px;
      border: 1px solid rgba(56, 189, 248, 0.22);
      box-shadow:
        0 0 0 1px rgba(34,211,238,0.08),
        0 8px 40px rgba(0,0,0,0.5),
        0 0 60px rgba(34,211,238,0.10);
      padding: 38px 32px 32px;
      animation: slideIn .45s cubic-bezier(.22,1,.36,1);
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(24px) scale(.97); }
      to   { opacity: 1; transform: translateY(0)    scale(1);   }
    }

    /* ‚îÄ‚îÄ Cabe√ßalho ‚îÄ‚îÄ */
    .logo-wrap {
      text-align: center;
      margin-bottom: 30px;
    }
    .logo-icon {
      font-size: 2.8rem;
      line-height: 1;
      display: block;
      margin-bottom: 10px;
      filter: drop-shadow(0 0 10px rgba(34,211,238,0.5));
    }
    .titulo {
      font-size: 1.15rem;
      font-weight: 700;
      color: #22d3ee;
      letter-spacing: .02em;
      line-height: 1.3;
    }
    .subtitulo {
      font-size: 0.78rem;
      color: #94a3b8;
      margin-top: 4px;
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ Campos ‚îÄ‚îÄ */
    .campo {
      position: relative;
      margin-bottom: 14px;
    }
    .campo label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 6px;
      letter-spacing: .04em;
      text-transform: uppercase;
    }
    .campo .icone {
      position: absolute;
      left: 12px;
      bottom: 13px;
      font-size: 1rem;
      pointer-events: none;
      opacity: .5;
    }
    .campo input {
      width: 100%;
      padding: 13px 12px 13px 38px;
      border-radius: 10px;
      border: 1.5px solid rgba(56,189,248,0.15);
      background: #1f2937;
      color: #e5e7eb;
      font-size: 0.95rem;
      outline: none;
      transition: border .2s, box-shadow .2s;
    }
    .campo input:focus {
      border-color: #22d3ee;
      box-shadow: 0 0 0 3px rgba(34,211,238,0.12);
    }
    .campo input::placeholder { color: #4b5563; }

    .toggle-senha {
      position: absolute;
      right: 12px;
      bottom: 13px;
      font-size: 1rem;
      cursor: pointer;
      opacity: .45;
      transition: opacity .2s;
      user-select: none;
    }
    .toggle-senha:hover { opacity: .9; }

    /* ‚îÄ‚îÄ Bot√£o ‚îÄ‚îÄ */
    #btnEntrar {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(90deg, #22d3ee, #38bdf8);
      color: #0a0f1f;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform .18s, box-shadow .18s, filter .18s;
      margin-top: 6px;
      letter-spacing: .03em;
      box-shadow: 0 4px 20px rgba(34,211,238,0.30);
    }
    #btnEntrar:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
      box-shadow: 0 6px 28px rgba(34,211,238,0.42);
    }
    #btnEntrar:active  { transform: translateY(0); filter: brightness(.95); }
    #btnEntrar:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    #btnEntrar .spinner {
      display: inline-block;
      width: 16px; height: 16px;
      border: 2.5px solid rgba(10,15,31,.3);
      border-top-color: #0a0f1f;
      border-radius: 50%;
      animation: spin .7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Erro ‚îÄ‚îÄ */
    .erro {
      color: #f87171;
      font-size: 0.85rem;
      text-align: center;
      margin-top: 12px;
      min-height: 20px;
      transition: all .2s;
    }
    .erro:not(:empty) {
      background: rgba(248,113,113,0.08);
      border: 1px solid rgba(248,113,113,0.25);
      border-radius: 8px;
      padding: 8px 12px;
    }

    /* ‚îÄ‚îÄ Rodap√© ‚îÄ‚îÄ */
    .rodape {
      margin-top: 22px;
      text-align: center;
      font-size: 0.75rem;
      color: #374151;
      letter-spacing: .03em;
    }

    @media (max-width: 420px) {
      .login-card { padding: 28px 20px 24px; }
    }
  </style>
</head>

<body>

  <div class="login-card">

    <div class="logo-wrap">
      <span class="logo-icon">üéµ</span>
      <div class="titulo">Orquestra Filhos de Asafe</div>
      <div class="subtitulo">Sistema de Desempenho</div>
    </div>

    <div class="campo">
      <label for="nome">Nome</label>
      <span class="icone">üë§</span>
      <input type="text" id="nome" placeholder="Seu nome completo" autocomplete="name" />
    </div>

    <div class="campo">
      <label for="senha">Senha</label>
      <span class="icone">üîí</span>
      <input type="password" id="senha" placeholder="Sua senha" autocomplete="current-password" />
      <span class="toggle-senha" id="toggleSenha" title="Mostrar / ocultar senha">üëÅÔ∏è</span>
    </div>

    <button id="btnEntrar">Entrar</button>

    <div id="erro" class="erro" role="alert" aria-live="polite"></div>

    <div class="rodape">Prefeitura Municipal de Diamantina</div>
  </div>

  <script type="module">
    import { db } from "./firebase-config.js";
    import { salvarUsuarioAtual, garantirFormato } from "./auth.js";
    import {
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const nomeInput   = document.getElementById("nome");
    const senhaInput  = document.getElementById("senha");
    const btnEntrar   = document.getElementById("btnEntrar");
    const erro        = document.getElementById("erro");
    const toggleSenha = document.getElementById("toggleSenha");

    garantirFormato();

    /* ‚îÄ‚îÄ Toggle senha ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    toggleSenha.addEventListener("click", () => {
      const show = senhaInput.type === "password";
      senhaInput.type = show ? "text" : "password";
      toggleSenha.textContent = show ? "üôà" : "üëÅÔ∏è";
    });

    /* ‚îÄ‚îÄ Enter nos campos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    nomeInput.addEventListener("keydown", e => {
      if (e.key === "Enter") senhaInput.focus();
    });
    senhaInput.addEventListener("keydown", e => {
      if (e.key === "Enter") btnEntrar.click();
    });

    /* ‚îÄ‚îÄ Login com detec√ß√£o autom√°tica de perfil ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    btnEntrar.addEventListener("click", async () => {
      const nome  = nomeInput.value.trim();
      const senha = senhaInput.value.trim();

      erro.textContent = "";

      if (!nome || !senha) {
        erro.textContent = "Preencha nome e senha.";
        return;
      }

      btnEntrar.disabled = true;
      btnEntrar.innerHTML = '<span class="spinner"></span>Aguarde...';

      try {
        // 1¬∫ tenta como professor
        const qProf    = query(collection(db, "usuarios"), where("nome", "==", nome));
        const snapProf = await getDocs(qProf);

        if (!snapProf.empty) {
          const prof = snapProf.docs[0].data();
          if (prof.senha !== senha) {
            erro.textContent = "Senha incorreta.";
            return;
          }
          salvarUsuarioAtual(prof.nome, "professor");
          window.location.href = "professor.html";
          return;
        }

        // 2¬∫ tenta como aluno
        const qAluno    = query(collection(db, "alunos"), where("nome", "==", nome));
        const snapAluno = await getDocs(qAluno);

        if (!snapAluno.empty) {
          const aluno = snapAluno.docs[0].data();
          if (aluno.senha !== senha) {
            erro.textContent = "Senha incorreta.";
            return;
          }
          salvarUsuarioAtual(aluno.nome, "aluno", aluno.classificado === true);
          window.location.href = `aluno.html?nome=${encodeURIComponent(aluno.nome)}`;
          return;
        }

        // N√£o encontrado em nenhuma cole√ß√£o
        erro.textContent = "Usu√°rio n√£o encontrado.";

      } catch (err) {
        erro.textContent = "Erro de conex√£o. Tente novamente.";
        console.error(err);
      } finally {
        btnEntrar.disabled = false;
        btnEntrar.innerHTML = "Entrar";
      }
    });
  </script>

</body>
</html>
