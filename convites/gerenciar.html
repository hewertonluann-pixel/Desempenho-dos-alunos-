<script type="module">
import { db } from "../firebase-config.js";
import {
  collection,
  addDoc,
  getDocs,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const lista = document.getElementById('listaLinks');
const resultado = document.getElementById('resultado');
const status = document.getElementById('status');

const colConvites = collection(db, "convites_recital");

async function gerarLink() {
  const nome = document.getElementById('nome').value.trim();
  const linkBase = document.getElementById('linkBase').value.trim();

  if (!nome) {
    alert('Digite o nome do convidado');
    return;
  }

  try {
    const docRef = await addDoc(colConvites, {
      nome,
      confirmado: false,
      criadoEm: serverTimestamp()
    });

    const linkFinal = `${linkBase}?id=${docRef.id}&nome=${encodeURIComponent(nome)}`;

    resultado.style.display = 'block';
    resultado.textContent = linkFinal;
    document.querySelector('.copiar').style.display = 'block';

    adicionarNaLista(nome, linkFinal, false);
    status.textContent = "✅ Convite criado com sucesso!";
  } catch (erro) {
    console.error("Erro ao gerar convite:", erro);
    status.textContent = "❌ Erro ao gerar convite.";
  }
}

function adicionarNaLista(nome, link, confirmado) {
  const item = document.createElement('li');
  item.style.marginBottom = '12px';
  item.innerHTML = `
    <strong>${nome}</strong><br>
    <span style="color:#94a3b8;">${link}</span><br>
    <span style="color:${confirmado ? '#22c55e' : '#facc15'};">
      ${confirmado ? 'Confirmado' : 'Pendente'}
    </span>
  `;
  lista.appendChild(item);
}

async function carregarLista() {
  lista.innerHTML = '';
  const q = query(colConvites, orderBy("criadoEm", "desc"));
  const snap = await getDocs(q);

  snap.forEach(docSnap => {
    const dados = docSnap.data();
    const linkFinal = `convite.html?id=${docSnap.id}&nome=${encodeURIComponent(dados.nome)}`;
    adicionarNaLista(dados.nome, linkFinal, dados.confirmado);
  });
}

// MÉTODO DE CÓPIA SEGURO
function copiarLinkManual() {
  const range = document.createRange();
  range.selectNode(resultado);
  const selection = window.getSelection();
  selection.removeAllRanges();
  selection.addRange(range);
  status.textContent = '✅ Link selecionado. Use CTRL + C para copiar.';
}

// TESTES
document.addEventListener('DOMContentLoaded', () => {
  console.assert(typeof gerarLink === 'function', 'gerarLink não definido');
  carregarLista();
});

// Tornando funções globais para botões inline
window.gerarLink = gerarLink;
window.copiarLinkManual = copiarLinkManual;
</script>
