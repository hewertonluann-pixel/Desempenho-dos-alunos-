<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Aluno ‚Äî Orquestra Filhos de Asafe</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="aluno.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap"></noscript>

  <style>
    :root{--neon-cyan:#22d3ee;--neon-blue:#38bdf8;--dark-bg:#0a0f1f;--card-bg:rgba(17,24,39,0.95);--glow:0 0 20px rgba(34,211,238,0.4);}*{box-sizing:border-box;}body{margin:0;background:linear-gradient(135deg,#0a0f1f 0%,#0b1025 50%,#1a0d2e 100%);font-family:"Inter","Segoe UI",sans-serif;color:#e2e8f0;overflow-x:hidden;position:relative;}body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 20% 80%,rgba(34,211,238,.08) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(56,189,248,.08) 0%,transparent 50%);animation:nebula 8s ease-in-out infinite alternate;z-index:-1;pointer-events:none;}@keyframes nebula{0%{opacity:.6;transform:scale(1);}100%{opacity:1;transform:scale(1.1);}}.main-container{display:flex;min-height:100vh;animation:fadeIn .8s ease-out;}@keyframes fadeIn{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}.sidebar{width:280px;flex-shrink:0;padding:20px;background:var(--card-bg);backdrop-filter:blur(12px);border-right:1px solid rgba(56,189,248,.2);overflow-y:auto;animation:slideInLeft .6s ease-out;}@keyframes slideInLeft{from{transform:translateX(-20px);opacity:0;}to{transform:translateX(0);opacity:1;}}@media (max-width:768px){.sidebar{position:fixed;top:0;left:0;height:100vh;z-index:1000;transform:translateX(-100%);transition:transform .3s ease;}.sidebar.open{transform:translateX(0);}.main-container{padding-left:0;}body.menu-open::after{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:999;backdrop-filter:blur(4px);}}.card{background:var(--card-bg);backdrop-filter:blur(12px);border-radius:16px;padding:24px;margin-bottom:24px;border:1px solid rgba(56,189,248,.2);box-shadow:var(--glow),0 8px 32px rgba(0,0,0,.3);transition:all .3s ease;animation:cardRise .5s ease-out forwards;opacity:0;transform:translateY(20px);}.card:nth-child(1){animation-delay:.1s;}.card:nth-child(2){animation-delay:.2s;}.card:nth-child(3){animation-delay:.3s;}@keyframes cardRise{to{opacity:1;transform:translateY(0);}}.card:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(34,211,238,.3);border-color:var(--neon-cyan);}.skeleton{background:linear-gradient(90deg,#1f2937 25%,#374151 50%,#1f2937 75%);background-size:200% 100%;animation:loading 1.5s infinite;border-radius:8px;}@keyframes loading{0%{background-position:200% 0;}100%{background-position:-200% 0;}}button{background:linear-gradient(135deg,var(--neon-cyan),var(--neon-blue));border:none;border-radius:12px;padding:12px 20px;color:#0a0f1f;font-weight:600;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden;}button:hover:not(:disabled){transform:translateY(-2px);box-shadow:var(--glow);}button:disabled{opacity:.6;cursor:not-allowed;}.popup,.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;justify-content:center;align-items:center;z-index:2000;animation:modalFade .3s ease-out;}@keyframes modalFade{from{opacity:0;}to{opacity:1;}}.popup-content,.modal-content{background:var(--card-bg);border-radius:20px;padding:32px;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:var(--glow),0 20px 60px rgba(0,0,0,.5);}.close-button,.close-btn{float:right;font-size:28px;cursor:pointer;color:#9ca3af;transition:color .3s;margin-top:-16px;}.close-button:hover,.close-btn:hover{color:var(--neon-cyan);}.content-area{flex:1;padding:20px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--neon-cyan) transparent;}.content-area::-webkit-scrollbar{width:6px;}.content-area::-webkit-scrollbar-track{background:transparent;}.content-area::-webkit-scrollbar-thumb{background:var(--neon-cyan);border-radius:3px;}@media (max-width:768px){.content-area{padding:16px;}.card{padding:20px;margin-bottom:20px;}}.mobile-menu-btn{display:none;position:fixed;top:16px;left:16px;z-index:1001;background:var(--neon-cyan);border-radius:50%;width:48px;height:48px;color:#0a0f1f;}@media (max-width:768px){.mobile-menu-btn{display:block;}}

    /* Novo CSS para r√≥tulos adicionais nas li√ß√µes */
    .lesson-label {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 5px;
    }
    .lesson-score, .reading-method-label {
      cursor: pointer;
      user-select: none;
      transition: color 0.3s;
    }
    .lesson-score:hover, .reading-method-label:hover {
      color: var(--neon-cyan);
    }

    /* CSS para centralizar o t√≠tulo e ajustar bot√£o Modo Professor */
    .profile-card .aluno-name {
      text-align: center;
      margin-bottom: 10px;
    }
    .profile-card .btn-professor-mode {
      display: block;
      margin-top: 10px;
      position: static;
    }

    /* CSS para tornar os valores de Leitura e M√©todo clic√°veis no sidebar */
    .detail-item .detail-value {
      cursor: pointer;
      user-select: none;
      transition: color 0.3s;
    }
    .detail-item .detail-value:hover {
      color: var(--neon-cyan);
    }
  </style>

  <!-- üîí SAFESET: Fix pro erro "null textContent" no aluno.js -->
  <script>
    // Fun√ß√µes seguras
    window.safeSet = function(id, value) {
      const el = document.getElementById(id);
      if (!el) { console.warn(`‚ùå #${id} n√£o encontrado!`); return false; }
      el.textContent = value; return true;
    };
    window.safeHTML = function(id, html) {
      const el = document.getElementById(id);
      if (!el) { console.warn(`üìÇ HTML em #${id} falhou`); return false; }
      el.innerHTML = html; return true;
    };
    window.removeEmpty = function(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove('empty');
    };

    // Fun√ß√£o para obter dados globais de Leitura/M√©todo
    function obterDadosGlobais() {
      const data = localStorage.getItem('leituraMetodoGlobal');
      if (data) {
        return JSON.parse(data);
      }
      return { leitura: '', metodo: '' };
    }

    // Fun√ß√£o para atualizar r√≥tulos das li√ß√µes (chamada ap√≥s salvar ou carregar)
    window.atualizarRotulosLicoes = function() {
      const dados = obterDadosGlobais();
      // Para cada li√ß√£o, atualize o r√≥tulo baseado no placar
      // Assumindo que voc√™ tem IDs como 'rotulo_licao1', etc., em licoes.js
      // Exemplo hipot√©tico: para uma li√ß√£o, defina como dados.metodo se 'M√©todo', ou dados.leitura se 'Leitura'
      // Aqui, conforme exemplo, abaixo do n√∫mero, coloque o m√©todo (Bona)
      // Voc√™ precisa ajustar em licoes.js para cada li√ß√£o f√∂ colocada caixa clic√°vel 'Leitura' ou 'M√©todo' e o r√≥tulo abaixo.
      document.querySelectorAll('.reading-method-label').forEach(el => {
        const tipo = el.dataset.tipo; // Assume que voc√™ adicionar√° data-tipo="metodo" ou "leitura"
        if (tipo === 'metodo') {
          el.textContent = dados.metodo || '';
        } else if (tipo === 'leitura') {
          el.textContent = dados.leitura || '';
        }
      });
    };

    // Fun√ß√£o para abrir popup de Leitura/M√©todo (agora acionada pelos labels no sidebar ou nas li√ß√µes)
    window.abrirPopupLeituraMetodo = function(tipo) {
      console.log('üîç Abrindo popup de Leitura/M√©todo para tipo:', tipo);
      const popup = document.getElementById('popupLeituraMetodo');
      if (!popup) {
        console.error('‚ùå Popup n√£o encontrado no DOM!');
        return;
      }
      // Armazenar tipo para saber qual campo destacar/default
      window.editingTipo = tipo;
      popup.style.display = 'flex';
      popup.classList.add('active');

      // Carregar dados globais
      const dados = obterDadosGlobais();
      document.getElementById('popupLeitura').value = dados.leitura;
      document.getElementById('popupMetodo').value = dados.metodo;

      // Destaque o campo se espec√≠fico
      const leituraInput = document.getElementById('popupLeitura');
      const metodoInput = document.getElementById('popupMetodo');
      if (tipo === 'leitura') {
        leituraInput.focus();
      } else if (tipo === 'metodo') {
        metodoInput.focus();
      }
    };

    // Fun√ß√£o para salvar
    window.salvarPopupLeituraMetodo = function() {
      const leitura = document.getElementById('popupLeitura').value.trim();
      const metodo = document.getElementById('popupMetodo').value.trim();
      const data = { leitura, metodo };
      localStorage.setItem('leituraMetodoGlobal', JSON.stringify(data));
      atualizarRotulosLicoes(); // Atualiza r√≥tulos nas li√ß√µes
      console.log('üíæ Salvo global: Leitura:', leitura, 'M√©todo:', metodo);
      fecharPopupLeituraMetodo();
    };

    // Fun√ß√£o para fechar
    window.fecharPopupLeituraMetodo = function() {
      const popup = document.getElementById('popupLeituraMetodo');
      if (popup) {
        popup.style.display = 'none';
        popup.classList.remove('active');
      }
    };

    // Fun√ß√£o para abrir popup de conquistas (corrigida)
    window.abrirPopupConquista = function(icone, titulo, descricao, detalhes) {
      console.log('üîç Abrindo popup de conquista:', titulo);
      const popup = document.getElementById('popupConquista');
      if (!popup) {
        console.error('‚ùå Popup de conquista n√£o encontrado!');
        return;
      }
      popup.style.display = 'flex';
      popup.classList.add('active');

      // Definir conte√∫do
      safeSet('conquistaIcone', icone || 'üèÜ');
      safeSet('conquistaTitulo', titulo || 'Conquista');
      safeSet('conquistaDescricao', descricao || 'Descri√ß√£o n√£o dispon√≠vel.');
      const detailsEl = document.getElementById('conquistaDetalhes');
      if (detailsEl && detalhes) {
        detailsEl.innerHTML = detalhes.map(item => `<li>${item}</li>`).join('');
      }
    };

    // Fun√ß√£o para fechar popup de conquistas
    window.fecharPopupConquista = function() {
      const popup = document.getElementById('popupConquista');
      if (popup) {
        popup.style.display = 'none';
        popup.classList.remove('active');
      }
    };

    // DOM pronto
    document.addEventListener('DOMContentLoaded', () => {
      console.log('‚úÖ DOM Pronto - Iniciando...');

      // Adicionar listeners para Leitura e M√©todo no sidebar
      const nivelLeitura = document.getElementById('nivelLeitura');
      const nivelMetodo = document.getElementById('nivelMetodo');
      if (nivelLeitura) {
        console.log('‚úÖ Listener adicionado em #nivelLeitura');
        nivelLeitura.addEventListener('click', () => {
          console.log('üéØ Clicou em Leitura');
          abrirPopupLeituraMetodo('leitura');
        });
      } else {
        console.warn('‚ö†Ô∏è #nivelLeitura n√£o encontrado');
      }
      if (nivelMetodo) {
        console.log('‚úÖ Listener adicionado em #nivelMetodo');
        nivelMetodo.addEventListener('click', () => {
          console.log('üéØ Clicou em M√©todo');
          abrirPopupLeituraMetodo('metodo');
        });
      } else {
        console.warn('‚ö†Ô∏è #nivelMetodo n√£o encontrado');
      }

      // Carregar r√≥tulos iniciais das li√ß√µes
      atualizarRotulosLicoes();

      // Inicializar painel aluno
      if (typeof iniciarPainelAluno === 'function') {
        iniciarPainelAluno();
      } else {
        console.warn('‚ö†Ô∏è Fun√ß√£o iniciarPainelAluno n√£o encontrada');
      }
    });

    // ESC para fechar popups
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        fecharPopupLeituraMetodo();
        fecharPopupConquista();
        if (typeof fecharPopup === 'function') fecharPopup();
        document.body.classList.remove('menu-open');
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.classList.remove('open');
      }
    });
  </script>
</head>

<body>
  <!-- Bot√£o Mobile Menu -->
  <button id="mobileMenuBtn" class="mobile-menu-btn" title="Menu">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>

  <div class="main-container">
    <aside class="sidebar" id="sidebar">
      <div class="profile-card">
        <div class="photo-upload">
          <img id="fotoAluno" src="https://via.placeholder.com/150?text=üë§" alt="Foto do aluno" class="profile-photo" loading="lazy">
          <label for="novaFoto" class="upload-icon" aria-label="Alterar foto">
            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
            </svg>
          </label>
          <input type="file" id="novaFoto" accept="image/*" onchange="enviarNovaFoto()" style="display:none;">
        </div>
        <h1 class="aluno-name" id="nomeAluno">Nome do Aluno</h1>
        <p class="instrument" id="instrumentoAluno">Instrumento</p>
        <div class="level-info">
          <span class="level-label">N√≠vel Geral</span>
          <span class="level-value" id="nivelGeral">0</span>
        </div>
        <div class="level-details">
          <div class="detail-item">
            <span class="detail-label">Leitura</span>
            <span class="detail-value" id="nivelLeitura">0</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">M√©todo</span>
            <span class="detail-value" id="nivelMetodo">0</span>
          </div>
        </div>
        <button class="btn-change-password" onclick="abrirPopup()">üîí Alterar Senha</button>
        <button class="btn-professor-mode" id="modoProfessorBtn" style="display:none;" onclick="acessarModoProfessor()">üë®‚Äçüè´ Modo Professor</button>
      </div>
      
      <div class="social-link-card">
        <a href="painel-social.html" class="social-link" aria-label="Painel Social">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          Painel Social da Orquestra
        </a>
      </div>
    </aside>

    <main class="content-area">
      <section class="energy-section card">
        <h2>‚ö° Energia (Frequ√™ncia do M√™s)</h2>
        <div class="energy-bar-wrapper">
          <div class="energy-bar">
            <div class="energy-level" id="barraEnergia" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div>
          </div>
          <div style="position:relative;"><span class="energy-value" id="valorEnergia">0%</span></div>
        </div>
      </section>

      <section class="achievements-section card">
        <h2>üèÜ <a href="manual.html" target="_blank" style="color:inherit;text-decoration:none;">Conquistas</a></h2>
        <div class="achievements-grid empty" id="grade-conquistas"></div>
      </section>

      <section class="frequency-section card">
        <h2>üìÖ Frequ√™ncia Anual</h2>
        <div class="year-control">
          <button id="anoAnterior" class="arrow-btn">&lt;</button>
          <span id="anoAtualTexto" class="current-year"></span>
          <button id="anoProximo" class="arrow-btn">&gt;</button>
        </div>
        <div class="frequency-grid empty" id="gradeFrequencia"></div>
      </section>

      <section class="evolucao-section card">
        <h2>üìà Evolu√ß√£o T√©cnica</h2>
        <div id="painelEvolucao"></div>
      </section>

      <section class="lessons-section card">
        <h2>üé§ Li√ß√µes Enviadas</h2>
        <button class="btn-send-lesson" onclick="abrirModalEnviarLicao()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14"></path><path d="M12 5v14"></path>
          </svg>
          Enviar nova li√ß√£o
        </button>
        <div id="listaLicoes" class="lessons-list empty">
          <!-- Modelo para integrar em licoes.js: Para cada li√ß√£o dinamicamente gerada, use algo como:
          <div class="licao-item">
            <div class="lesson-score" onclick="abrirPopupLeituraMetodo('leitura')">Leitura</div>
            <div class="lesson-number" id="numero-licao-1">96</div>
            <div class="reading-method-label lesson-label" data-tipo="metodo" id="rotulo-licao-1"></div>
          </div>
          Ou clique em M√©todo para outro. Ap√≥s gerar, chame atualizarRotulosLicoes() para preencher.
          -->
        </div>
      </section>
    </main>
  </div>

  <!-- Popup para Leitura e M√©todo -->
  <div id="popupLeituraMetodo" class="popup" style="display:none;">
    <div class="popup-content">
      <span class="close-btn" onclick="fecharPopupLeituraMetodo()">√ó</span>
      <h2>üìñ Definir Leitura e M√©todo</h2>
      <label for="popupLeitura">Leitura (ex.: Bona):</label>
      <input type="text" id="popupLeitura" placeholder="Digite sua leitura">
      <label for="popupMetodo">M√©todo (ex.: Amadeu Russo):</label>
      <input type="text" id="popupMetodo" placeholder="Digite seu m√©todo">
      <button onclick="salvarPopupLeituraMetodo()">üíæ Salvar</button>
    </div>
  </div>

  <!-- Modals Existentes -->
  <div id="popupFrequencia" class="popup" style="display:none;">
    <div class="popup-content"></div>
  </div>
  <div id="popupConquista" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-button" onclick="fecharPopupConquista()">&times;</span>
      <div class="conquista-header">
        <span id="conquistaIcone" class="achievement-icon"></span>
        <h2 id="conquistaTitulo"></h2>
      </div>
      <p id="conquistaDescricao"></p>
      <h3>Detalhes da Conquista:</h3>
      <ul id="conquistaDetalhes"></ul>
    </div>
  </div>
  <div id="popupSenha" class="popup" style="display:none;">
    <div class="popup-content">
      <h2>Alterar Senha</h2>
      <input type="password" id="novaSenha" placeholder="Nova senha">
      <button onclick="salvarSenha()">Salvar</button>
      <p id="mensagemSenha"></p>
      <span class="close-btn" onclick="fecharPopup()">√ó</span>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="grafico-evolucao.js"></script>
  <script>
    // Mobile menu
    document.addEventListener('DOMContentLoaded', () => {
      const mobileBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('sidebar');
      const isMobile = window.innerWidth <= 768;
      if (mobileBtn && sidebar && isMobile) {
        mobileBtn.addEventListener('click', () => {
          document.body.classList.toggle('menu-open');
          sidebar.classList.toggle('open');
        });
      }
    });
  </script>
  <script type="module" src="aluno.js"></script>
  <script type="module" src="navegacao.js"></script>
  <script src="js/recorder.js"></script>
  <script type="module" src="licoes.js"></script>
</body>
</html>
