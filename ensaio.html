<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chamada do dia - Orquestra Filhos de Asafe</title>

  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
    h1 { text-align: center; margin-bottom: 10px; color: #333; }
    #tipoAtual { font-size: 1rem; color: #666; font-weight: normal; }

    /* Switch */
    .switch-container { display: flex; align-items: center; justify-content: center; margin: 15px 0 25px; font-weight: bold; gap: 10px; transition: opacity 0.3s ease; }
    .switch-label { color: #333; font-size: 1rem; }
    .switch { position: relative; display: inline-block; width: 60px; height: 30px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #bbb; transition: 0.4s; border-radius: 30px; }
    .slider::before { position: absolute; content: ""; height: 24px; width: 24px; left: 3px; bottom: 3px; background-color: white; transition: 0.4s; border-radius: 50%; }
    input:checked + .slider { background-color: #9c27b0; }
    input:checked + .slider::before { transform: translateX(30px); }

    /* Cards dos alunos */
    .painel { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .container-aluno { background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 200px; padding: 10px; text-align: center; cursor: pointer; transition: 0.3s; }
    .container-aluno:hover { transform: scale(1.03); }
    .foto { width: 100%; height: 120px; background-color: #eee; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; }
    .foto img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }

    /* Estados */
    .container-aluno.vazio { background-color: #fff; border: 1px solid #ccc; }
    .container-aluno.presente { background-color: #c8f7c5; border: 2px solid #4caf50; }
    .container-aluno.ausente { background-color: #f7c5c5; border: 2px solid #f44336; }

    textarea { width: 100%; margin-top: 20px; padding: 10px; border-radius: 6px; border: 1px solid #ccc; resize: vertical; }
    .botoes { text-align: center; margin-top: 20px; }
    .botoes button { padding: 10px 20px; margin: 0 10px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; background-color: #2196f3; color: white; transition: background 0.3s; }
    .botoes button:hover { background-color: #1976d2; }
    .cancelar { background-color: #dc2626 !important; }
    .cancelar:hover { background-color: #b91c1c !important; }

    /* Loader */
    .loader-fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f5f5f5; display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 9999; flex-wrap: wrap; }
    .loader-fullscreen.inactive { display: none; }

    .nota { font-size: 3rem; animation: subir 1s infinite alternate ease-in-out; }
    @keyframes subir { 0% { transform: translateY(0); opacity: 0.5; } 100% { transform: translateY(-50px); opacity: 1; } }
  </style>
</head>

<body>
  <!-- Loader -->
  <div class="loader-fullscreen" id="loader">
    <div class="nota">üéµ</div><div class="nota">üé∂</div><div class="nota">üéº</div><div class="nota">üéª</div><div class="nota">üé∫</div>
  </div>

  <h1>üìã Chamada do dia <span id="tipoAtual"></span>: <span id="dataEnsaio"></span></h1>

  <!-- Seletor -->
  <div class="switch-container" id="switchTipo">
    <span class="switch-label">üéº Ensaio</span>
    <label class="switch">
      <input type="checkbox" id="tipoEventoSwitch">
      <span class="slider"></span>
    </label>
    <span class="switch-label">üé§ Apresenta√ß√£o</span>
  </div>

  <div class="painel" id="painelAlunos"></div>
  <textarea id="observacoes" placeholder="Observa√ß√µes..."></textarea>

  <div class="botoes">
    <button onclick="salvarPresencas()">üíæ Gravar Presen√ßas</button>
    <button class="cancelar" onclick="cancelarEvento()">‚ùå Cancelar Evento</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, getDocs, updateDoc, doc, getDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDdMROcKph5I-ClMiOmPiBXgGpDxoF2dZc",
      authDomain: "asafenotas-5cf3f.firebaseapp.com",
      projectId: "asafenotas-5cf3f",
      storageBucket: "asafenotas-5cf3f.appspot.com",
      messagingSenderId: "312062581585",
      appId: "1:312062581585:web:432ff63a527dd86fc1170",
      measurementId: "G-Z6G6D4RKZQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const loader = document.getElementById("loader");
    const painel = document.getElementById("painelAlunos");
    const hoje = new Date().toISOString().split("T")[0];
    const mesAtual = hoje.slice(0, 7);

    document.getElementById("dataEnsaio").textContent = new Date().toLocaleDateString("pt-BR");

    const params = new URLSearchParams(window.location.search);
    const ensaioId = params.get("id");

    let alunos = [];
    let presencasSalvas = {};
    let tipoEvento = "ensaio";
    let veioDeEvento = false;
    let colecaoOrigem = null;

    async function detectarOrigem() {
      colecaoOrigem = null;
      veioDeEvento = false;

      if (!ensaioId) {
        document.getElementById("switchTipo").style.display = "flex";
        return null;
      }

      const colecoes = ["eventos", "ensaios", "apresentacoes"];
      for (const c of colecoes) {
        const ref = doc(db, c, ensaioId);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const dados = snap.data();
          colecaoOrigem = c;

          // EVENTO PENDENTE
          if (c === "eventos") {
            veioDeEvento = true;
            tipoEvento = dados.tipo || "ensaio";
            document.getElementById("tipoAtual").textContent = tipoEvento === "apresentacao" ? "(Evento ‚Äî Apresenta√ß√£o)" : "(Evento ‚Äî Ensaio)";
            document.getElementById("tipoEventoSwitch").checked = tipoEvento === "apresentacao";
            document.getElementById("switchTipo").style.display = "flex";
          }

          // ENSAIO SALVO
          else if (c === "ensaios") {
            tipoEvento = "ensaio";
            document.getElementById("tipoAtual").textContent = "(Ensaio)";
            document.getElementById("switchTipo").style.display = "none";
          }

          // APRESENTA√á√ÉO SALVA
          else if (c === "apresentacoes") {
            tipoEvento = "apresentacao";
            document.getElementById("tipoAtual").textContent = "(Apresenta√ß√£o)";
            document.getElementById("switchTipo").style.display = "none";
          }

          // Pr√©-carregar presen√ßas e observa√ß√µes
          if (dados.presencas) {
            dados.presencas.forEach(p => presencasSalvas[p.nome] = p.presenca);
          }
          document.getElementById("observacoes").value = dados.observacoes || "";

          return;
        }
      }

      // N√£o achou ID ‚Üí novo evento
      document.getElementById("switchTipo").style.display = "flex";
    }

    document.getElementById("tipoEventoSwitch").addEventListener("change", e => {
      tipoEvento = e.target.checked ? "apresentacao" : "ensaio";
    });

    async function carregarAlunos() {
      await detectarOrigem();
      const snapshot = await getDocs(collection(db, "alunos"));

      alunos = snapshot.docs.map(docItem => {
        const a = docItem.data();
        const estado = presencasSalvas[a.nome] || "";
        return { id: docItem.id, ...a, presenca: estado };
      });

      painel.innerHTML = alunos.map(a => `
        <div class="container-aluno ${a.presenca || 'vazio'}">
          <div class="foto">${a.foto ? `<img src="${a.foto}">` : "Sem foto"}</div>
          <strong>${a.nome}</strong><br>
          <small>${a.instrumento || ""}</small>
        </div>
      `).join("");

      loader.classList.add("inactive");
    }

    painel.addEventListener("click", e => {
      const card = e.target.closest(".container-aluno");
      if (!card) return;

      const nome = card.querySelector("strong").textContent;
      const aluno = alunos.find(a => a.nome === nome);

      aluno.presenca = aluno.presenca === "presente"
        ? "ausente"
        : aluno.presenca === "ausente"
        ? ""
        : "presente";

      card.className = `container-aluno ${aluno.presenca || "vazio"}`;
    });

    //----------------------------------------------------------
    // FUN√á√ÉO PRINCIPAL: SALVAR LISTA DE PRESEN√áAS + FREQU√äNCIA
    //----------------------------------------------------------
    window.salvarPresencas = async function() {
      const observacoes = document.getElementById("observacoes").value;
      const presencas = alunos.map(a => ({
        nome: a.nome,
        instrumento: a.instrumento || "",
        presenca: a.presenca
      }));

      const colecaoDestino = tipoEvento === "apresentacao" ? "apresentacoes" : "ensaios";

      //----------------------------------------------------------
      // 1. SALVAR O EVENTO (N√ÉO DUPLICAR)
      //----------------------------------------------------------
      if (ensaioId && colecaoOrigem && colecaoOrigem !== "eventos") {
        await updateDoc(doc(db, colecaoOrigem, ensaioId), { data: hoje, observacoes, presencas });
      }
      else if (ensaioId && veioDeEvento) {
        await addDoc(collection(db, colecaoDestino), { data: hoje, observacoes, presencas });
        await deleteDoc(doc(db, "eventos", ensaioId));
      }
      else {
        await addDoc(collection(db, colecaoDestino), { data: hoje, observacoes, presencas });
      }

      //----------------------------------------------------------
      // 2. ATUALIZAR FREQU√äNCIA ANUAL + MENSAL + HIST√ìRICO
      //----------------------------------------------------------
      for (const aluno of alunos) {
        const ref = doc(db, "alunos", aluno.id);
        const snap = await getDoc(ref);
        if (!snap.exists()) continue;

        const dados = snap.data();
        let historico = dados.presencas || [];

        let mesRegistro = historico.find(p => p.mes === mesAtual);
        if (!mesRegistro) {
          mesRegistro = { mes: mesAtual, totalEnsaios: 0, presencasAluno: 0, percentual: 0 };
          historico.push(mesRegistro);
        }

        mesRegistro.totalEnsaios++;
        if (aluno.presenca === "presente") mesRegistro.presencasAluno++;

        mesRegistro.percentual =
          Math.round((mesRegistro.presencasAluno / mesRegistro.totalEnsaios) * 100);

        // Frequ√™ncia mensal
        const frequenciaMensal = { porcentagem: mesRegistro.percentual };

        // Frequ√™ncia anual
        const meses = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
        const nomeMes = meses[parseInt(mesAtual.split("-")[1]) - 1];

        const frequenciaAnual = dados.frequenciaAnual || {};
        frequenciaAnual[nomeMes] = mesRegistro.percentual;

        await updateDoc(ref, {
          presencas: historico,
          frequenciaMensal,
          frequenciaAnual
        });
      }

      alert("‚úîÔ∏è Chamada salva com sucesso!");
      window.location.href = "professor.html";
    };

    //----------------------------------------------------------
    // CANCELAR
    //----------------------------------------------------------
    window.cancelarEvento = async function() {
      if (veioDeEvento && ensaioId) {
        const confirma = confirm("Deseja cancelar este evento pendente?");
        if (confirma) await deleteDoc(doc(db, "eventos", ensaioId));
      }
      window.location.href = "professor.html";
    };

    carregarAlunos();
  </script>

<script type="module" src="navegacao.js"></script>
  
</body>
</html>

