<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chamada do dia - Orquestra Filhos de Asafe</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 4px;
      color: #111827;
    }
    .subtitulo {
      text-align: center;
      font-size: 0.95rem;
      color: #4b5563;
      margin-bottom: 16px;
    }
    .data-evento {
      text-align: center;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1f2933;
    }
    .painel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .container-aluno {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      border: 1px solid #e5e7eb;
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease, background 0.15s ease;
    }
    .container-aluno.vazio {
      opacity: 0.8;
    }
    .container-aluno.presente {
      border-color: #16a34a;
      background: #ecfdf3;
    }
    .container-aluno.ausente {
      border-color: #dc2626;
      background: #fef2f2;
    }
    .container-aluno:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .nome {
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }
    .instrumento {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .botoes-presenca {
      display: flex;
      gap: 6px;
    }
    .botoes-presenca button {
      flex: 1;
      padding: 6px 0;
      font-size: 0.85rem;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }
    .btn-presente {
      background: #ecfdf3;
      border-color: #16a34a;
      color: #166534;
    }
    .btn-presente.ativo {
      background: #16a34a;
      color: #ecfdf3;
    }
    .btn-ausente {
      background: #fef2f2;
      border-color: #dc2626;
      color: #b91c1c;
    }
    .btn-ausente.ativo {
      background: #dc2626;
      color: #fef2f2;
    }
    .botoes-presenca button:hover {
      transform: translateY(-1px);
    }
    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      font-family: inherit;
      resize: vertical;
      margin-top: 4px;
    }
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.08);
    }
    .label-observacoes {
      font-size: 0.9rem;
      color: #374151;
      margin-top: 8px;
      display: block;
    }
    .botoes {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .botoes button {
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
    }
    .botoes button:active {
      transform: scale(0.97);
    }
    .salvar {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(37,99,235,0.4);
    }
    .salvar[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    .cancelar {
      background: #e5e7eb;
      color: #111827;
    }
    .info {
      text-align: center;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 10px;
    }
    .loader {
      text-align: center;
      margin-top: 20px;
      color: #4b5563;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <h1>üìã Chamada do dia</h1>
  <div class="subtitulo">Registre presen√ßas e aus√™ncias da orquestra em um √∫nico lugar.</div>
  <div class="data-evento">Data da chamada: <span id="dataEvento">--/--/----</span></div>

  <div class="info" id="infoCarregando">Carregando alunos...</div>
  <div class="painel" id="painelAlunos"></div>

  <label class="label-observacoes" for="observacoes">Observa√ß√µes (tipo de encontro, local, detalhes...)</label>
  <textarea id="observacoes" placeholder="Ex.: Ensaio geral, prepara√ß√£o para apresenta√ß√£o no centro."></textarea>

  <div class="botoes">
    <button id="btnSalvar" class="salvar">üíæ Salvar chamada</button>
    <button class="cancelar" id="btnCancelar">‚ùå Cancelar chamada</button>
  </div>

  <div class="loader" id="loader" style="display:none;">Salvando chamada e atualizando frequ√™ncias...</div>

  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      collection,
      getDocs,
      getDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    let eventoId = params.get("id") || null;
    let alunos = [];
    let dataEvento = null;

    const painel = document.getElementById("painelAlunos");
    const spanData = document.getElementById("dataEvento");
    const infoCarregando = document.getElementById("infoCarregando");
    const observacoesEl = document.getElementById("observacoes");
    const btnSalvar = document.getElementById("btnSalvar");
    const btnCancelar = document.getElementById("btnCancelar");
    const loader = document.getElementById("loader");

    function hojeISO() {
      return new Date().toISOString().split("T")[0];
    }

    function formatarDataBrasileira(iso) {
      if (!iso) return "--/--/----";
      const [ano, mes, dia] = iso.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    async function carregarAlunos() {
      const snap = await getDocs(collection(db, "alunos"));
      alunos = snap.docs
        .map(d => {
          const dados = d.data();
          return {
            id: d.id,
            nome: dados.nome,
            instrumento: dados.instrumento || "",
            presenca: "" // ser√° preenchido pelo evento, se existir
          };
        })
        .sort((a, b) => a.nome.localeCompare(b.nome, "pt-BR"));
    }

    async function carregarEventoSeExistir() {
      if (!eventoId) {
        dataEvento = hojeISO();
        spanData.textContent = formatarDataBrasileira(dataEvento);
        return;
      }

      const ref = doc(db, "eventos", eventoId);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        dataEvento = hojeISO();
        spanData.textContent = formatarDataBrasileira(dataEvento);
        return;
      }

      const dados = snap.data();
      dataEvento = dados.data || hojeISO();
      spanData.textContent = formatarDataBrasileira(dataEvento);
      observacoesEl.value = dados.observacoes || "";

      const mapaPresencas = {};
      (dados.presencas || []).forEach(p => {
        if (p && p.nome) mapaPresencas[p.nome] = p.presenca;
      });

      alunos.forEach(a => {
        a.presenca = mapaPresencas[a.nome] || "";
      });
    }

    function atualizarClasseCard(card, aluno) {
      card.className = "container-aluno " + (aluno.presenca || "vazio");

      const btnPres = card.querySelector(".btn-presente");
      const btnAus = card.querySelector(".btn-ausente");
      btnPres.classList.toggle("ativo", aluno.presenca === "presente");
      btnAus.classList.toggle("ativo", aluno.presenca === "ausente");
    }

    function renderizarAlunos() {
      painel.innerHTML = "";
      alunos.forEach(aluno => {
        const card = document.createElement("div");
        card.className = "container-aluno " + (aluno.presenca || "vazio");

        const nomeDiv = document.createElement("div");
        nomeDiv.className = "nome";
        nomeDiv.textContent = aluno.nome;

        const instrDiv = document.createElement("div");
        instrDiv.className = "instrumento";
        instrDiv.textContent = aluno.instrumento || "";

        const botoesDiv = document.createElement("div");
        botoesDiv.className = "botoes-presenca";

        const btnPres = document.createElement("button");
        btnPres.className = "btn-presente";
        btnPres.textContent = "Presente";

        const btnAus = document.createElement("button");
        btnAus.className = "btn-ausente";
        btnAus.textContent = "Ausente";

        btnPres.onclick = () => {
          aluno.presenca = "presente";
          atualizarClasseCard(card, aluno);
        };

        btnAus.onclick = () => {
          aluno.presenca = "ausente";
          atualizarClasseCard(card, aluno);
        };

        botoesDiv.appendChild(btnPres);
        botoesDiv.appendChild(btnAus);

        card.appendChild(nomeDiv);
        card.appendChild(instrDiv);
        card.appendChild(botoesDiv);

        painel.appendChild(card);
        atualizarClasseCard(card, aluno);
      });
    }

    async function inicializar() {
      infoCarregando.style.display = "block";
      await carregarAlunos();
      await carregarEventoSeExistir();
      infoCarregando.style.display = "none";
      renderizarAlunos();
    }

    async function salvarPresencas() {
      try {
        btnSalvar.disabled = true;
        loader.style.display = "block";

        const observacoes = observacoesEl.value.trim();
        const presencas = alunos.map(a => ({
          nome: a.nome,
          instrumento: a.instrumento || "",
          presenca: a.presenca || "ausente"
        }));

        if (!dataEvento) {
          dataEvento = hojeISO();
        }

        if (eventoId) {
          await updateDoc(doc(db, "eventos", eventoId), {
            data: dataEvento,
            observacoes,
            presencas
          });
        } else {
          const novo = await addDoc(collection(db, "eventos"), {
            data: dataEvento,
            observacoes,
            presencas
          });
          eventoId = novo.id;
        }

        await recalcularFrequenciasDoMes(dataEvento);

        alert("‚úîÔ∏è Chamada salva e frequ√™ncias atualizadas com sucesso!");
        window.location.href = "professor.html";
      } catch (e) {
        console.error(e);
        alert("Ocorreu um erro ao salvar a chamada.");
      } finally {
        btnSalvar.disabled = false;
        loader.style.display = "none";
      }
    }

    async function recalcularFrequenciasDoMes(dataISO) {
      const [ano, mes] = dataISO.split("-");
      const chaveMes = `${ano}-${mes}`; // ex: 2025-11

      const eventosSnap = await getDocs(collection(db, "eventos"));
      const eventosMes = [];
      eventosSnap.forEach(docSnap => {
        const dados = docSnap.data();
        if (!dados.data) return;
        if (dados.data.startsWith(chaveMes)) {
          eventosMes.push(dados);
        }
      });

      const totalEventosMes = eventosMes.length;
      if (!totalEventosMes) return;

      const contagemPorAluno = {};
      eventosMes.forEach(ev => {
        (ev.presencas || []).forEach(p => {
          if (!p || !p.nome) return;
          if (!contagemPorAluno[p.nome]) contagemPorAluno[p.nome] = 0;
          if (p.presenca === "presente") contagemPorAluno[p.nome]++;
        });
      });

      const mesesSiglas = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
      const idxMes = parseInt(mes, 10) - 1;
      const siglaMes = mesesSiglas[idxMes] || mes;

      const alunosSnap = await getDocs(collection(db, "alunos"));
      for (const docSnap of alunosSnap.docs) {
        const dados = docSnap.data();
        const nome = dados.nome;
        const presencasAluno = contagemPorAluno[nome] || 0;
        const percentual = Math.round((presencasAluno / totalEventosMes) * 100);

        const historico = Array.isArray(dados.presencas) ? [...dados.presencas] : [];
        let registroMes = historico.find(r => r.mes === chaveMes);
        if (!registroMes) {
          registroMes = {
            mes: chaveMes,
            totalEnsaios: totalEventosMes,
            presencasAluno,
            percentual
          };
          historico.push(registroMes);
        } else {
          registroMes.totalEnsaios = totalEventosMes;
          registroMes.presencasAluno = presencasAluno;
          registroMes.percentual = percentual;
        }

        const frequenciaMensal = {
          porcentagem: percentual,
          totalEventos: totalEventosMes,
          presencas: presencasAluno
        };

        const frequenciaAnual = dados.frequenciaAnual || {};
        frequenciaAnual[siglaMes] = {
          percentual,
          totalEnsaios: totalEventosMes,
          presencasAluno
        };

        await updateDoc(doc(db, "alunos", docSnap.id), {
          presencas: historico,
          frequenciaMensal,
          frequenciaAnual
        });
      }
    }

    async function cancelarEvento() {
      if (!eventoId) {
        if (confirm("Cancelar e voltar ao painel do professor?")) {
          window.location.href = "professor.html";
        }
        return;
      }

      const confirma = confirm("Deseja cancelar e excluir esta chamada?");
      if (!confirma) return;

      await deleteDoc(doc(db, "eventos", eventoId));
      alert("Chamada exclu√≠da com sucesso.");
      window.location.href = "professor.html";
    }

    btnSalvar.addEventListener("click", salvarPresencas);
    btnCancelar.addEventListener("click", cancelarEvento);

    inicializar();
  </script>

  <script type="module" src="navegacao.js"></script>
</body>
</html>

