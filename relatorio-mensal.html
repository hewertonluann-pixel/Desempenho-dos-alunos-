<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rio de Progresso Mensal</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">

  <style>
    /* ===== CONFIGURA√á√ÉO A4 PARA IMPRESS√ÉO ===== */
    @page {
      size: A4;
      margin: 15mm;
    }

    /* ===== RESET ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ===== TELA: TEMA ESCURO ===== */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #e2e8f0;
      min-height: 100vh;
      padding: 20px;
    }

    /* ===== BARRA SUPERIOR (N√ÉO IMPRESSA) ===== */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 900px;
      margin: 0 auto 20px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .top-bar h1 {
      color: #22d3ee;
      font-size: 1.4em;
      font-weight: 700;
      text-shadow: 0 0 10px rgba(34,211,238,0.4);
    }

    .top-bar-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-print {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(14,165,233,0.3);
    }
    .btn-print:hover {
      background: linear-gradient(135deg, #0284c7, #0369a1);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(14,165,233,0.5);
    }

    .btn-voltar {
      background: rgba(30,41,59,0.9);
      color: #94a3b8;
      border: 1px solid rgba(56,189,248,0.3);
      border-radius: 10px;
      padding: 10px 18px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn-voltar:hover {
      color: #22d3ee;
      border-color: rgba(34,211,238,0.6);
    }

    /* ===== LOADER ===== */
    #loader-relatorio {
      text-align: center;
      padding: 60px 20px;
      color: #22d3ee;
    }
    .spinner-rel {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(34,211,238,0.2);
      border-top-color: #22d3ee;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== P√ÅGINA DO RELAT√ìRIO ===== */
    .page {
      width: 100%;
      max-width: 900px;
      background: #fff;
      color: #1a202c;
      margin: 0 auto;
      padding: 30px 35px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }

    /* ===== CABE√áALHO DO RELAT√ìRIO ===== */
    .rel-header {
      display: flex;
      align-items: center;
      gap: 20px;
      border-bottom: 3px solid #0ea5e9;
      padding-bottom: 20px;
      margin-bottom: 24px;
    }

    .rel-foto {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      object-fit: cover;
      border: 3px solid #0ea5e9;
      flex-shrink: 0;
      background: #e2e8f0;
    }

    .rel-info h1 {
      font-size: 1.8em;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 4px;
    }
    .rel-info .instrumento {
      font-size: 1em;
      color: #475569;
      font-weight: 500;
    }
    .rel-info .periodo {
      font-size: 0.9em;
      color: #64748b;
      margin-top: 4px;
    }

    .rel-logo {
      margin-left: auto;
      text-align: right;
      flex-shrink: 0;
    }
    .rel-logo .titulo-sistema {
      font-size: 1em;
      font-weight: 700;
      color: #0ea5e9;
    }
    .rel-logo .subtitulo-sistema {
      font-size: 0.8em;
      color: #64748b;
    }

    /* ===== SE√á√ÉO T√çTULO ===== */
    .rel-titulo-secao {
      font-size: 1.05em;
      font-weight: 700;
      color: #0f172a;
      border-left: 4px solid #0ea5e9;
      padding-left: 10px;
      margin-bottom: 14px;
      margin-top: 24px;
    }

    /* ===== CARDS DE INDICADORES ===== */
    .indicadores-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 24px;
    }

    .indicador-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      background: #f8fafc;
    }

    .indicador-card h4 {
      font-size: 0.85em;
      color: #475569;
      margin-bottom: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .indicador-valores {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-bottom: 10px;
    }

    .ind-val {
      flex: 1;
      padding: 6px 4px;
      border-radius: 8px;
      background: #f1f5f9;
      font-size: 0.78em;
      color: #475569;
    }
    .ind-val span {
      display: block;
      font-size: 1.1em;
      font-weight: 700;
      color: #1e293b;
      margin-top: 2px;
    }
    .ind-val.atual {
      background: #dbeafe;
      border: 2px solid #3b82f6;
    }
    .ind-val.atual span {
      color: #1d4ed8;
    }

    .indicador-status {
      font-size: 0.82em;
      font-weight: 700;
      padding: 5px 10px;
      border-radius: 20px;
      display: inline-block;
    }
    .status-evoluiu  { background: #dcfce7; color: #166534; }
    .status-estavel  { background: #fef9c3; color: #854d0e; }
    .status-regrediu { background: #fee2e2; color: #991b1b; }
    .status-neutro   { background: #f1f5f9; color: #475569; }

    /* ===== COMPROMETIMENTO ===== */
    .comprometimento-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 24px;
    }

    .comp-card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      background: #f8fafc;
    }

    .comp-card h4 {
      font-size: 0.85em;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }

    .comp-valor {
      font-size: 2.2em;
      font-weight: 800;
      color: #0f172a;
      line-height: 1;
    }

    .comp-detalhe {
      font-size: 0.82em;
      color: #64748b;
      margin-top: 4px;
    }

    .comp-barra-wrap {
      margin-top: 10px;
      background: #e2e8f0;
      border-radius: 100px;
      height: 8px;
      overflow: hidden;
    }
    .comp-barra-fill {
      height: 100%;
      border-radius: 100px;
      transition: width 0.5s ease;
    }
    .fill-verde  { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .fill-amarelo { background: linear-gradient(90deg, #f59e0b, #d97706); }
    .fill-vermelho { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .fill-azul { background: linear-gradient(90deg, #3b82f6, #2563eb); }

    /* ===== AN√ÅLISE ===== */
    .analise-box {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 24px;
      line-height: 1.7;
      font-size: 0.92em;
      color: #0f172a;
    }

    /* ===== CONQUISTAS ===== */
    .conquistas-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 24px;
    }

    .conquista-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 0.85em;
    }

    .conquista-item.ouro    { border-color: #f59e0b; background: #fffbeb; }
    .conquista-item.prata   { border-color: #94a3b8; background: #f8fafc; }
    .conquista-item.lendario { border-color: #8b5cf6; background: #f5f3ff; }

    .conquista-icone { font-size: 1.3em; }
    .conquista-info strong {
      display: block;
      font-weight: 700;
      color: #1e293b;
    }
    .conquista-info span {
      font-size: 0.82em;
      color: #64748b;
    }

    .sem-conquistas {
      color: #94a3b8;
      font-style: italic;
      font-size: 0.9em;
    }

    /* ===== PRESEN√áA DETALHADA ===== */
    .presenca-section {
      margin-bottom: 24px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88em;
    }

    th, td {
      border: 1px solid #e2e8f0;
      padding: 8px 12px;
      text-align: center;
    }

    th {
      background: #f1f5f9;
      font-weight: 700;
      color: #475569;
      text-transform: uppercase;
      font-size: 0.8em;
      letter-spacing: 0.05em;
    }

    tr:nth-child(even) td { background: #f8fafc; }

    .td-presente { color: #16a34a; font-weight: 700; }
    .td-ausente  { color: #dc2626; font-weight: 700; }

    /* ===== RODAP√â ===== */
    .rel-footer {
      border-top: 2px solid #e2e8f0;
      padding-top: 14px;
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      font-size: 0.8em;
      color: #94a3b8;
    }

    .assinatura-linha {
      border-top: 1px solid #94a3b8;
      width: 200px;
      text-align: center;
      padding-top: 6px;
      font-size: 0.85em;
      color: #475569;
    }

    /* ===== IMPRESS√ÉO ===== */
    @media print {
      body {
        background: white !important;
        padding: 0 !important;
        color: #1a202c !important;
      }
      .top-bar { display: none !important; }
      .page {
        box-shadow: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        max-width: 100% !important;
      }
      .indicador-card,
      .comp-card,
      .conquista-item,
      .analise-box {
        break-inside: avoid;
      }
    }

    /* ===== RESPONSIVIDADE ===== */
    @media (max-width: 600px) {
      .indicadores-grid { grid-template-columns: 1fr; }
      .comprometimento-grid { grid-template-columns: 1fr; }
      .rel-header { flex-direction: column; text-align: center; }
      .rel-logo { margin-left: 0; text-align: center; }
    }
  </style>
</head>

<body>

  <!-- BARRA SUPERIOR (N√ÉO IMPRESSA) -->
  <div class="top-bar">
    <h1>üìä Relat√≥rio de Progresso Mensal</h1>
    <div class="top-bar-actions">
      <button class="btn-voltar" onclick="history.back()">‚Üê Voltar</button>
      <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir / Salvar PDF</button>
    </div>
  </div>

  <!-- LOADER -->
  <div id="loader-relatorio">
    <div class="spinner-rel"></div>
    <p>Carregando dados do aluno...</p>
  </div>

  <!-- P√ÅGINA DO RELAT√ìRIO (preenchida via JS) -->
  <div class="page" id="pagina-relatorio" style="display:none;"></div>

  <!-- FIREBASE + SCRIPT -->
  <script type="module">
    import { db } from "./firebase-config.js";
    import {
      collection, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    import { regrasDeConquistas } from "./conquistas.js";

    /* ===== MESES ===== */
    const MESES = {
      "01":"Janeiro","02":"Fevereiro","03":"Mar√ßo","04":"Abril",
      "05":"Maio","06":"Junho","07":"Julho","08":"Agosto",
      "09":"Setembro","10":"Outubro","11":"Novembro","12":"Dezembro"
    };

    /* ===== OBTER PAR√ÇMETROS DA URL ===== */
    const params = new URLSearchParams(window.location.search);
    const alunoId = params.get("id");
    const mesSelecionado = params.get("mes"); // "2026-02"

    if (!alunoId) {
      document.getElementById("loader-relatorio").innerHTML =
        `<p style="color:#ef4444;">‚ùå Nenhum aluno selecionado. Volte √† p√°gina do professor.</p>`;
    } else {
      gerarRelatorio(alunoId, mesSelecionado);
    }

    /* ===== GERAR RELAT√ìRIO ===== */
    async function gerarRelatorio(id, mesChave) {
      try {
        // 1. Carregar dados do aluno
        const alunoSnap = await getDoc(doc(db, "alunos", id));
        if (!alunoSnap.exists()) throw new Error("Aluno n√£o encontrado.");
        const aluno = { id: alunoSnap.id, ...alunoSnap.data() };

        // 2. Determinar m√™s/ano
        const agora = new Date();
        const anoAtual = agora.getFullYear();
        const mesAtual = String(agora.getMonth() + 1).padStart(2, "0");
        const chave = mesChave || `${anoAtual}-${mesAtual}`;
        const [anoRel, mesRel] = chave.split("-");

        // 3. Carregar eventos do m√™s e do ano
        const snapEventos = await getDocs(collection(db, "eventos"));
        const todoEventos = snapEventos.docs.map(d => ({ id: d.id, ...d.data() }));

        const eventosMes = todoEventos.filter(e => e.data && e.data.startsWith(chave));
        const eventosAno = todoEventos.filter(e => e.data && e.data.startsWith(`${anoRel}-`));

        // 4. Calcular frequ√™ncia mensal
        const freqMes = calcularFrequencia(eventosMes, aluno.nome);

        // 5. Calcular frequ√™ncia geral (anual)
        const freqGeral = calcularFrequencia(eventosAno, aluno.nome);

        // 6. Calcular conquistas do m√™s
        const alunoSimuladoMes = {
          ...aluno,
          frequenciaMensal: { porcentagem: freqMes.percentual }
        };
        const conquistasMes = regrasDeConquistas.filter(c => c.condicao(alunoSimuladoMes));

        // 7. Dados do m√™s anterior (para compara√ß√£o)
        const mesAnteriorChave = getMesAnterior(chave);
        const eventosMesAnterior = todoEventos.filter(e => e.data && e.data.startsWith(mesAnteriorChave));
        const freqMesAnterior = calcularFrequencia(eventosMesAnterior, aluno.nome);

        // 8. Montar presen√ßa detalhada
        const presencaDetalhada = eventosMes.map(ev => {
          const p = ev.presencas?.find(x => x.nome === aluno.nome);
          return {
            data: formatarData(ev.data),
            status: p?.presenca === "presente" ? "Presente" : "Ausente"
          };
        }).sort((a, b) => a.data.localeCompare(b.data));

        // 9. Renderizar
        renderizarRelatorio({
          aluno, anoRel, mesRel,
          freqMes, freqGeral, freqMesAnterior,
          conquistasMes, presencaDetalhada, chave
        });

      } catch (err) {
        console.error(err);
        document.getElementById("loader-relatorio").innerHTML =
          `<p style="color:#ef4444;">‚ùå Erro ao carregar relat√≥rio: ${err.message}</p>`;
      }
    }

    /* ===== CALCULAR FREQU√äNCIA ===== */
    function calcularFrequencia(eventos, nomeAluno) {
      if (!eventos || eventos.length === 0) return { total: 0, presencas: 0, percentual: 0 };
      const total = eventos.length;
      const presencas = eventos.filter(ev => {
        const p = ev.presencas?.find(x => x.nome === nomeAluno);
        return p?.presenca === "presente";
      }).length;
      return { total, presencas, percentual: Math.round((presencas / total) * 100) };
    }

    /* ===== M√äS ANTERIOR ===== */
    function getMesAnterior(chave) {
      const [ano, mes] = chave.split("-").map(Number);
      const d = new Date(ano, mes - 2, 1);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`;
    }

    /* ===== FORMATAR DATA ===== */
    function formatarData(iso) {
      if (!iso) return "-";
      const [a, m, d] = iso.split("-");
      return `${d}/${m}/${a}`;
    }

    /* ===== STATUS COMPARATIVO ===== */
    function gerarStatus(atual, anterior) {
      if (anterior === 0 && atual === 0) return { texto: "‚Äî Sem dados", classe: "status-neutro" };
      if (atual > anterior) return { texto: "‚ñ≤ Evoluiu", classe: "status-evoluiu" };
      if (atual === anterior) return { texto: "‚óè Est√°vel", classe: "status-estavel" };
      return { texto: "‚ñº Regrediu", classe: "status-regrediu" };
    }

    /* ===== COR DA BARRA ===== */
    function corBarra(pct) {
      if (pct >= 80) return "fill-verde";
      if (pct >= 50) return "fill-amarelo";
      return "fill-vermelho";
    }

    /* ===== AN√ÅLISE AUTOM√ÅTICA ===== */
    function gerarAnalise(aluno, freqMes, freqGeral, freqMesAnterior) {
      const partes = [];

      // Presen√ßa
      if (freqMes.total === 0) {
        partes.push("N√£o h√° registros de chamada para este m√™s.");
      } else {
        const stPres = gerarStatus(freqMes.percentual, freqMesAnterior.percentual);
        if (stPres.classe === "status-evoluiu")
          partes.push(`A frequ√™ncia do aluno melhorou em rela√ß√£o ao m√™s anterior, atingindo ${freqMes.percentual}% de presen√ßa.`);
        else if (stPres.classe === "status-estavel")
          partes.push(`A frequ√™ncia do aluno manteve-se est√°vel em ${freqMes.percentual}% de presen√ßa.`);
        else
          partes.push(`A frequ√™ncia do aluno apresentou queda em rela√ß√£o ao m√™s anterior, com ${freqMes.percentual}% de presen√ßa. Recomenda-se refor√ßar a regularidade nos ensaios.`);
      }

      // Leitura
      const leitura = aluno.leitura || 0;
      if (leitura >= 80) partes.push(`O n√≠vel de leitura musical est√° excelente (n√≠vel ${leitura}), demonstrando grande dedica√ß√£o aos estudos de solfejo.`);
      else if (leitura >= 40) partes.push(`O n√≠vel de leitura musical est√° em progress√£o (n√≠vel ${leitura}). Manter a pr√°tica constante garantir√° evolu√ß√£o cont√≠nua.`);
      else partes.push(`O n√≠vel de leitura musical (n√≠vel ${leitura}) indica que o aluno est√° nos est√°gios iniciais. Intensificar os estudos de solfejo √© recomendado.`);

      // M√©todo
      const metodo = aluno.metodo || 0;
      if (metodo >= 80) partes.push(`O progresso no m√©todo instrumental √© not√°vel (unidade ${metodo}), evidenciando comprometimento exemplar.`);
      else if (metodo >= 40) partes.push(`O progresso no m√©todo instrumental est√° avan√ßando (unidade ${metodo}). Continuar com regularidade nos estudos.`);
      else partes.push(`O m√©todo instrumental est√° na unidade ${metodo}. √â importante manter foco e disciplina para acelerar o aprendizado.`);

      // Comprometimento geral
      if (freqGeral.percentual >= 85)
        partes.push(`O comprometimento geral do aluno ao longo do ano √© excelente (${freqGeral.percentual}%), sendo um exemplo de dedica√ß√£o.`);
      else if (freqGeral.percentual >= 60)
        partes.push(`O comprometimento geral anual √© satisfat√≥rio (${freqGeral.percentual}%), com espa√ßo para melhoria na regularidade.`);
      else if (freqGeral.total > 0)
        partes.push(`O comprometimento geral anual (${freqGeral.percentual}%) requer aten√ß√£o. Recomenda-se conversa motivacional com o aluno.`);

      return partes.join(" ");
    }

    /* ===== RENDERIZAR RELAT√ìRIO ===== */
    function renderizarRelatorio({ aluno, anoRel, mesRel, freqMes, freqGeral, freqMesAnterior, conquistasMes, presencaDetalhada, chave }) {
      const nomeMes = MESES[mesRel] || mesRel;
      const fotoSrc = aluno.foto || "https://via.placeholder.com/100";

      // Status indicadores
      const stPresenca = gerarStatus(freqMes.percentual, freqMesAnterior.percentual);
      const stLeitura  = gerarStatus(aluno.leitura || 0, 0); // sem hist√≥rico anterior dispon√≠vel
      const stMetodo   = gerarStatus(aluno.metodo || 0, 0);

      // An√°lise autom√°tica
      const analise = gerarAnalise(aluno, freqMes, freqGeral, freqMesAnterior);

      // Conquistas HTML
      let conquistasHTML = "";
      if (conquistasMes.length > 0) {
        conquistasHTML = conquistasMes.map(c => `
          <div class="conquista-item ${c.raridade || ''}">
            <span class="conquista-icone">${c.icone}</span>
            <div class="conquista-info">
              <strong>${c.titulo}</strong>
              <span>${c.descricao}</span>
            </div>
          </div>
        `).join("");
      } else {
        conquistasHTML = `<span class="sem-conquistas">Nenhuma conquista desbloqueada neste m√™s.</span>`;
      }

      // Presen√ßa detalhada HTML
      let presencaHTML = "";
      if (presencaDetalhada.length > 0) {
        presencaHTML = presencaDetalhada.map(p => `
          <tr>
            <td>${p.data}</td>
            <td class="${p.status === 'Presente' ? 'td-presente' : 'td-ausente'}">${p.status}</td>
          </tr>
        `).join("");
      } else {
        presencaHTML = `<tr><td colspan="2" style="color:#94a3b8; font-style:italic;">Nenhum registro de chamada neste m√™s.</td></tr>`;
      }

      const html = `
        <!-- CABE√áALHO -->
        <div class="rel-header">
          <img src="${fotoSrc}" class="rel-foto" alt="Foto de ${aluno.nome}" onerror="this.src='https://via.placeholder.com/100'">
          <div class="rel-info">
            <h1>${aluno.nome}</h1>
            <p class="instrumento">üéµ ${aluno.instrumento || "Instrumento n√£o definido"}</p>
            <p class="periodo">üìÖ Relat√≥rio de ${nomeMes} / ${anoRel}</p>
          </div>
          <div class="rel-logo">
            <div class="titulo-sistema">Filhos de Asafe</div>
            <div class="subtitulo-sistema">Sistema de Desempenho Musical</div>
          </div>
        </div>

        <!-- INDICADORES DE PROGRESSO -->
        <div class="rel-titulo-secao">üìà Indicadores de Progresso</div>
        <div class="indicadores-grid">

          <div class="indicador-card">
            <h4>Presen√ßa no M√™s</h4>
            <div class="indicador-valores">
              <div class="ind-val">Anterior<span>${freqMesAnterior.percentual}%</span></div>
              <div class="ind-val atual">Atual<span>${freqMes.percentual}%</span></div>
              <div class="ind-val">Meta<span>90%</span></div>
            </div>
            <span class="indicador-status ${stPresenca.classe}">${stPresenca.texto}</span>
          </div>

          <div class="indicador-card">
            <h4>Leitura (${aluno.leituraNome || 'Bona'})</h4>
            <div class="indicador-valores">
              <div class="ind-val">Anterior<span>‚Äî</span></div>
              <div class="ind-val atual">Atual<span>N√≠vel ${aluno.leitura || 1}</span></div>
              <div class="ind-val">Meta<span>‚Äî</span></div>
            </div>
            <span class="indicador-status ${stLeitura.classe}">N√≠vel ${aluno.leitura || 1}</span>
          </div>

          <div class="indicador-card">
            <h4>M√©todo (${aluno.metodoNome || 'M√©todo'})</h4>
            <div class="indicador-valores">
              <div class="ind-val">Anterior<span>‚Äî</span></div>
              <div class="ind-val atual">Atual<span>Unid. ${aluno.metodo || 1}</span></div>
              <div class="ind-val">Meta<span>‚Äî</span></div>
            </div>
            <span class="indicador-status ${stMetodo.classe}">Unidade ${aluno.metodo || 1}</span>
          </div>

        </div>

        <!-- COMPROMETIMENTO -->
        <div class="rel-titulo-secao">‚ö° Comprometimento</div>
        <div class="comprometimento-grid">

          <div class="comp-card">
            <h4>Comprometimento Mensal ‚Äî ${nomeMes}</h4>
            <div class="comp-valor">${freqMes.percentual}%</div>
            <div class="comp-detalhe">${freqMes.presencas} presen√ßa(s) de ${freqMes.total} chamada(s)</div>
            <div class="comp-barra-wrap">
              <div class="comp-barra-fill ${corBarra(freqMes.percentual)}" style="width:${freqMes.percentual}%"></div>
            </div>
          </div>

          <div class="comp-card">
            <h4>Comprometimento Geral ‚Äî ${anoRel}</h4>
            <div class="comp-valor">${freqGeral.percentual}%</div>
            <div class="comp-detalhe">${freqGeral.presencas} presen√ßa(s) de ${freqGeral.total} chamada(s) no ano</div>
            <div class="comp-barra-wrap">
              <div class="comp-barra-fill fill-azul" style="width:${freqGeral.percentual}%"></div>
            </div>
          </div>

        </div>

        <!-- AN√ÅLISE -->
        <div class="rel-titulo-secao">üìù An√°lise do Desempenho</div>
        <div class="analise-box">${analise}</div>

        <!-- CONQUISTAS DO M√äS -->
        <div class="rel-titulo-secao">üèÜ Conquistas do M√™s</div>
        <div class="conquistas-grid">${conquistasHTML}</div>

        <!-- PRESEN√áA DETALHADA -->
        <div class="rel-titulo-secao">üìã Controle de Presen√ßa ‚Äî ${nomeMes} ${anoRel}</div>
        <div class="presenca-section">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>${presencaHTML}</tbody>
          </table>
        </div>

        <!-- RODAP√â -->
        <div class="rel-footer">
          <div>
            <div>Gerado em: ${new Date().toLocaleDateString('pt-BR', { day:'2-digit', month:'long', year:'numeric' })}</div>
            <div style="margin-top:4px;">Sistema Filhos de Asafe ‚Äî Relat√≥rio de Progresso Mensal</div>
          </div>
          <div class="assinatura-linha">
            Professor Respons√°vel
          </div>
        </div>
      `;

      const pagina = document.getElementById("pagina-relatorio");
      pagina.innerHTML = html;
      pagina.style.display = "block";
      document.getElementById("loader-relatorio").style.display = "none";
    }
  </script>

</body>
</html>
